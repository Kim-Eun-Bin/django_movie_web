{% extends 'movie/header.html' %}

{% block content %}
    <div class="add-post-content">
        <form method="post" action="{% url 'add_new_post' %}">
            {% csrf_token %}
            <div class="post-find">
                <button name="movie_id" id="show" class="find-btn" type="button">
                    {% if selected_item %}
                        {{ selected_item.movie_title }}
                        <input style="display: none" name="movie_id" value="{{ selected_item.id }}" />
                    {% else %}
                        영화를 선택하세요 &nbsp;&nbsp;▼
                    {% endif %}
                </button>
                <button class="post-save-btn" type="submit">저장</button>
            </div>
            <input name="title" type="text" placeholder="제목"/>
            <textarea name="content" placeholder="내용을 입력하세요"></textarea>
        </form>
        <div class="popup-background">
            <div class="find-movie-popup-close">
                <div class="popup-close">
                    <button id="close" class="popup-close-btn" type="button">✕</button>
                </div>
                <div class="search">
                    <input id="search_movie_keyword" type="text" placeholder="search">
                    <button id="search-movie-btn" type="submit" class="search-btn"><img src="../../static/image/magnifying-glass.png"></button>
                </div>
                <div class="movie-table">
                    <table class="find-list-table">
                        <thead class="find-list-title">
                            <tr>
                                <th style="width: 55%">제목</th>
                                <th style="width: 15%">제작연도</th>
                                <th style="width: 10%">장르</th>
                                <th style="width: 10%">감독</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movie in movie_info %}
                                <tr class="find-list">
                                    <td class="text-hidden"><a href="/movie/review_list/post?movie={{ movie.id }}">{{ movie.movie_title }}</a></td>
                                    <td class="text-hidden">{{ movie.prdt_year }}</td>
                                    <td class="text-hidden">{{ movie.genre }}</td>
                                    <td class="text-hidden">{{ movie.director }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        open_btn = document.getElementById('show')
        close_btn = document.getElementById('close')

        open_btn.addEventListener("click", function() {
            document.querySelector(".find-movie-popup-close").className = "find-movie-popup";
            document.querySelector(".popup-background").className = "popup-background-show";
        })
        close_btn.addEventListener("click", function() {
            document.querySelector(".find-movie-popup").className = "find-movie-popup-close";
            document.querySelector(".popup-background-show").className = "popup-background";
        })

        $(document).ready(function() {
            $('#search-movie-btn').click(function() {
                let movie_title = $('#search_movie_keyword').val();
                if(movie_title === "") {
                    movie_title = "all";
                }
                $('tbody').empty();
                $.ajax({
                    url: "{% url 'search_movie' %}",
                    type: "post",
                    data: {
                        csrfmiddlewaretoken : '{{ csrf_token }}',
                        keyword : movie_title
                    },
                    dataType: "json",
                    success: function (data) {
                        let txt = "";
                        let id_list = [];
                        for(let obj of data) {
                            txt += '<tr class="find-list"><td class="text-hidden">' + '<a class="a_movie_title" href="/movie/review_list/post?movie=' + obj['id'] + '">' + obj['movie_title'] + '</a></td>';
                            txt += '<td class="text-hidden">' + obj['prdt_year'] + '</td>';
                            txt += '<td class="text-hidden">' + obj['genre'] + '</td>';
                            txt += '<td class="text-hidden">' + obj['director'] + '</td></tr>';
                            id_list.push(obj['id'])
                        }
                        $('tbody').append(txt);
                    }
                })
            })
        })
    </script>
{% endblock %}

